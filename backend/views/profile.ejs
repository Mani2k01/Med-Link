<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Patient Information</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f4f6f8;
            margin: 0;
            padding: 0;
        }

        .navbar {
            background: #009688;
            color: white;
            padding: 0 20px;
            height: 60px;
            display: flex;
            align-items: center;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            position: fixed;
            top: 0;
            width: 100%;
            z-index: 1000;
        }

        .navbar i {
            font-size: 28px;
            margin-right: 12px;
            color: #b2dfdb;
        }

        .navbar h1 {
            margin: 0;
            font-size: 23px;
            font-weight: 600;
            letter-spacing: 0.5px;
        }

        .navbar a{
            margin-left:auto;
            font-size:28px;
            cursor:pointer;
        }

        main {
            flex: 1 1 auto;
            overflow-y: auto;
            padding: 20px;
        }

        .container {
            padding: 90px 20px 80px;
            display: flex;
            justify-content: center;
            min-height: 100vh;
        }

        .form-box {
            background: white;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.12);
            width: 900px;
            max-width: 95%;
            margin: 20px auto;
        }

        .section-card {
            background: #f9f9f9;
            padding: 28px;
            border-radius: 16px;
            margin-bottom: 28px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.06);
        }

        .section-card h3 {
            color: #00796b;
            margin-bottom: 22px;
            font-weight: 600;
            font-size: 1.4rem;
            border-bottom: 2px solid #e0f2f1;
            padding-bottom: 8px;
        }

        .form-row {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .form-group {
            flex: 1;
            min-width: 280px;
        }

        input,
        select,
        textarea {
            width: 100%;
            padding: 14px 16px;
            border: 1.5px solid #ccc;
            border-radius: 14px;
            font-size: 15px;
            transition: all 0.3s;
            background: white;
        }

        .button-group {
            display: flex;
            justify-content: space-between;
            gap: 20px;
            margin-top: 35px;
        }

        .button-group button {
            flex: 1;
            max-width: 200px;
            padding: 14px;
            border: none;
            border-radius: 50px;
            font-weight: 600;
            font-size: 16px;
            cursor: pointer;
            transition: 0.3s;
        }

        .btn-submit {
            background: #009688;
            color: white;
        }

        .btn-back {
            background: #95a5a6;
            color: white;
        }

        footer {
            background: #009688;
            color: white;
            text-align: center;
            padding: 14px;
            position: fixed;
            bottom: 0;
            width: 100%;
            font-size: 14px;
        }

        .custom-dropdown-container {
            position: relative;
        }

        .custom-dropdown-container select {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            width: 100%;
            padding: 14px 36px 14px 16px;
            border: 1.5px solid #ccc;
            border-radius: 14px;
            font-size: 15px;
        }

        .custom-dropdown-container::after {
            content: 'â–¼';
            position: absolute;
            top: 50%;
            right: 30px;
            transform: translateY(-50%);
            pointer-events: none;
            font-size: 12px;
            color: #555;
        }

        @media (max-width: 768px) {
            .form-row {
                flex-direction: column;
            }
            .form-group {
                min-width: 100%;
            }
            .button-group {
                flex-direction: column;
            }
            .button-group button {
                max-width: none;
            }
        }
    </style>
</head>

<body>

<div class="navbar">
    <i class="fa-solid fa-stethoscope"></i>
    <h1>Patient Information</h1>
    <a href="/back"><i id="exit" class="fa-solid fa-arrow-right-from-bracket"></i></a>
</div>

<main>
<div class="container">

<div id="formSection" class="form-box">
<form id="patientForm" action="/profile/action" method="post">

<!-- Personal Information -->
<div class="section-card">
<h3>Personal Information</h3>

<div class="form-row">
<div class="form-group">
<input type="text" name="PatientId" placeholder="Patient ID"
value="<%= prfl_id || '' %>" readonly/>
</div>

<div class="form-group">
<input type="text" name="Name" placeholder="Name"
value="<%= result?.Name || '' %>" required/>
</div>
</div>

<div class="form-row">
<div class="form-group custom-dropdown-container">
<select name="gender" required>
<option value="">Gender</option>
<option value="Male" <%= result?.gender === 'Male' ? 'selected' : '' %>>Male</option>
<option value="Female" <%= result?.gender === 'Female' ? 'selected' : '' %>>Female</option>
<option value="Other" <%= result?.gender === 'Other' ? 'selected' : '' %>>Other</option>
</select>
</div>

<div class="form-group">
<input type="text" name="dob" placeholder="DOB"
value="<%= result?.dob || '' %>" required
onfocus="this.type='date'"
onblur="if(this.value==='') this.type='text'">
</div>

<div class="form-group"
id="ageContainer"
<% if (result && result.age) { %>
style="display:block;"
<% } else { %>
style="display:none;"
<% } %>>



<input type="text"
id="age"
name="age"
value="<%= result && result.age ? result.age : '' %>"
readonly>
</div>
</div>

<div class="form-row">
<div class="form-group custom-dropdown-container">
<select name="maritalStatus" required>
<option value="">Marital Status</option>
<option value="Un-Married" <%= result?.maritalStatus === 'Un-Married' ? 'selected' : '' %>>Un-Married</option>
<option value="Married" <%= result?.maritalStatus === 'Married' ? 'selected' : '' %>>Married</option>
<option value="Divorced" <%= result?.maritalStatus === 'Divorced' ? 'selected' : '' %>>Divorced</option>
<option value="Widowed" <%= result?.maritalStatus === 'Widowed' ? 'selected' : '' %>>Widowed</option>
</select>
</div>

<div class="form-group custom-dropdown-container">
<select name="bloodGroup" required>
<option value="">Blood Group</option>
<option value="A+" <%= result?.bloodGroup === 'A+' ? 'selected' : '' %>>A+</option>
<option value="A-" <%= result?.bloodGroup === 'A-' ? 'selected' : '' %>>A-</option>
<option value="B+" <%= result?.bloodGroup === 'B+' ? 'selected' : '' %>>B+</option>
<option value="B-" <%= result?.bloodGroup === 'B-' ? 'selected' : '' %>>B-</option>
<option value="O+" <%= result?.bloodGroup === 'O+' ? 'selected' : '' %>>O+</option>
<option value="O-" <%= result?.bloodGroup === 'O-' ? 'selected' : '' %>>O-</option>
<option value="AB+" <%= result?.bloodGroup === 'AB+' ? 'selected' : '' %>>AB+</option>
<option value="AB-" <%= result?.bloodGroup === 'AB-' ? 'selected' : '' %>>AB-</option>
</select>
</div>
</div>

<div class="form-row">
<div class="form-group">
<input type="text" name="nationality" placeholder="Nationality"
value="<%= result?.nationality || '' %>" required/>
</div>
<div class="form-group">
<input type="text" name="religion" placeholder="Religion"
value="<%= result?.religion || '' %>" required/>
</div>
</div>
</div>

<!-- Contact Information -->
<div class="section-card">
<h3>Contact Information</h3>

<div class="form-group">
<input type="email" name="email" placeholder="Email"
value="<%= result?.email || '' %>" required/>
</div><br>

<div class="form-row">
<div class="form-group">
<input type="text" name="guardianName" placeholder="Guardian Name"
value="<%= result?.guardianName || '' %>" required/>
</div>
<div class="form-group">
<input type="tel" name="contactNumber" placeholder="Contact Number"
pattern="[0-9]{10}"
value="<%= result?.contactNumber || '' %>" required/>
</div>
</div>

<div class="form-group">
<input type="tel" name="emergencyContact" placeholder="Emergency Contact Number"
pattern="[0-9]{10}"
value="<%= result?.emergencyContact || '' %>" required/>
</div><br>

<div class="form-group">
<textarea name="address" placeholder="Full Address" required>
<%= result?.address || '' %>
</textarea>
</div>
</div>

<!-- Identification Details -->
<div class="section-card">
<h3>Identification Details</h3>

<div class="form-group custom-dropdown-container">
<select id="idType" name="Identification Details" required onchange="updateInputBox()">
<option value="">Select</option>
<option value="Aadhaar" <%= !result || result?.['Identification Details'] === 'Aadhaar' ? 'selected' : '' %>>Aadhaar</option>
<option value="Passport" <%= result?.['Identification Details'] === 'Passport' ? 'selected' : '' %>>Passport</option>
<option value="Voter ID" <%= result?.['Identification Details'] === 'Voter ID' ? 'selected' : '' %>>Voter ID</option>
<option value="Driving License" <%= result?.['Identification Details'] === 'Driving License' ? 'selected' : '' %>>Driving License</option>
<option value="PAN" <%= result?.['Identification Details'] === 'PAN' ? 'selected' : '' %>>PAN</option>
</select>
</div><br>

<div class="form-group"
id="idInputContainer" style="display: block;"> 

<input type="text" id="idNumber" name="Identification no"
value="<%= prfl_id || '' %>" readonly>
</div>
</div>

<!-- Medical Information -->
<div class="section-card">
<h3>Medical Information</h3>

<div class="form-group">
<div id="diseaseWrapper" class="tag-input-wrapper">
<input type="text" name="diseaseName" id="diseaseInput"
placeholder="Disease Name"
value="<%= result?.diseaseName || '' %>" />
</div>
<input type="hidden" name="diseaseName" id="diseaseHidden">
</div><br>

<div class="form-group">
<div id="allergyWrapper" class="tag-input-wrapper">
<input type="text" name="allergies" id="allergyInput"
placeholder="Allergies (if any)"
value="<%= result?.allergies || '' %>" />
</div>
<input type="hidden" name="allergies" id="allergyHidden">
</div><br>

<div class="form-group">
<div id="medWrapper" class="tag-input-wrapper">
<input type="text" name="currentMeds" id="medInput"
placeholder="Current Medications (if any)"
value="<%= result?.currentMeds || '' %>" />
</div>
<input type="hidden" name="currentMeds" id="medHidden">
</div><br>
</div>

<div class="button-group">
<button type="submit" name="action" value="back">Back</button>
<button type="submit" name="action" value="submit" class="btn-submit">update</button>
</div>

</form>
</div>
</div>
</main>

    <footer>Â© 2025 VEDSP Inventive Private Limited. All rights reserved.</footer>

    <script>
        const form = document.getElementById('patientForm');
        const formSection = document.getElementById('formSection');
        const successSection = document.getElementById('successSection');
        const detailsSection = document.getElementById('detailsSection');
        const displayPatientId = document.getElementById('displayPatientId');
        const allDetails = document.getElementById('allDetails');

        let patientData = {};
        let uploadedFileName = "No file uploaded";


        function updateInputBox() {
            const idType = document.getElementById("idType").value;
            const container = document.getElementById("idInputContainer");
            const input = document.getElementById("idNumber");

            if (!idType) {
                container.style.display = "none";
                input.required = false;
                input.placeholder = "";
                input.value = "";
                return;
            }

            container.style.display = "block";
            input.required = true;

            switch (idType) {
                case "Aadhaar":
                    input.placeholder = "Enter Aadhaar Number (12 digits)";
                    input.maxLength = 12;
                    input.pattern = "[0-9]{12}";
                    break;

                case "Passport":
                    input.placeholder = "Enter Passport Number";
                    input.maxLength = 8;
                    input.pattern = "[A-za-z0-9]{6,8}";
                    break;

                case "Voter ID":
                    input.placeholder = "Enter Voter ID";
                    input.maxLength = 10;
                    input.pattern = "[A-Z]{3}[0-9]{7}";
                    break;

                case "Driving License":
                    input.placeholder = "Enter Driving License Number";
                    input.maxLength = 16;
                    input.pattern = "[A-Za-z0-9]{6,16}";
                    break;

                case "PAN":
                    input.placeholder = "Enter PAN Number";
                    input.maxLength = 10;
                    input.pattern = "[A-Z]{5}[0-9]{4}[A-Z]{1}";
                    break;
            }
        }
        // ==== DISEASE TAG INPUT (FINAL, CLEAN) ====

        const diseaseInput = document.getElementById("diseaseInput");
        const diseaseWrapper = document.getElementById("diseaseWrapper");
        const diseaseHidden = document.getElementById("diseaseHidden");

        let diseaseList = [];

        // ðŸ”’ Block Enter from submitting form when inside disease input
        form.addEventListener("keydown", function(e) {
            if (e.key === "Enter" && e.target === diseaseInput) {
                e.preventDefault();
            }
        });

        // âœ… Create tag on Enter or comma
        diseaseInput.addEventListener("keydown", function(e) {
            if (e.key === "Enter" || e.key === ",") {
                e.preventDefault();

                const value = diseaseInput.value.trim();
                if (value && !diseaseList.includes(value)) {
                    diseaseList.push(value);
                    addDiseaseTag(value);
                    updateHiddenInput();
                }

                diseaseInput.value = "";
            }
        });

        function addDiseaseTag(text) {
            const tag = document.createElement("div");
            tag.className = "tag";
            tag.innerHTML = `${text} <span>&times;</span>`;

            tag.querySelector("span").onclick = function() {
                removeDisease(text, tag);
            };

            diseaseWrapper.insertBefore(tag, diseaseInput);
        }

        function removeDisease(text, tagElement) {
            diseaseList = diseaseList.filter(d => d !== text);
            tagElement.remove();
            updateHiddenInput();
        }

        function updateHiddenInput() {
            diseaseHidden.value = diseaseList.join(", ");
        }

        // ==== ALLERGY TAG INPUT ====

        const allergyInput = document.getElementById("allergyInput");
        const allergyWrapper = document.getElementById("allergyWrapper");
        const allergyHidden = document.getElementById("allergyHidden");

        let allergyList = [];

        // ðŸ”’ Block Enter from submitting form when inside allergy input
        form.addEventListener("keydown", function(e) {
            if (e.key === "Enter" && e.target === allergyInput) {
                e.preventDefault();
            }
        });

        // âœ… Create allergy tag on Enter or comma
        allergyInput.addEventListener("keydown", function(e) {
            if (e.key === "Enter" || e.key === ",") {
                e.preventDefault();

                const value = allergyInput.value.trim();
                if (value && !allergyList.includes(value)) {
                    allergyList.push(value);
                    addAllergyTag(value);
                    updateAllergyHidden();
                }

                allergyInput.value = "";
            }
        });

        function addAllergyTag(text) {
            const tag = document.createElement("div");
            tag.className = "tag";
            tag.innerHTML = `${text} <span>&times;</span>`;

            tag.querySelector("span").onclick = function() {
                removeAllergy(text, tag);
            };

            allergyWrapper.insertBefore(tag, allergyInput);
        }

        function removeAllergy(text, tagElement) {
            allergyList = allergyList.filter(a => a !== text);
            tagElement.remove();
            updateAllergyHidden();
        }

        function updateAllergyHidden() {
            allergyHidden.value = allergyList.join(", ");
        }

        // ==== CURRENT MEDICATION TAG INPUT ====

        const medInput = document.getElementById("medInput");
        const medWrapper = document.getElementById("medWrapper");
        const medHidden = document.getElementById("medHidden");

        let medList = [];

        // ðŸ”’ Block Enter from submitting form when inside meds input
        form.addEventListener("keydown", function(e) {
            if (e.key === "Enter" && e.target === medInput) {
                e.preventDefault();
            }
        });

        // âœ… Create medication tag on Enter or comma
        medInput.addEventListener("keydown", function(e) {
            if (e.key === "Enter" || e.key === ",") {
                e.preventDefault();

                const value = medInput.value.trim();
                if (value && !medList.includes(value)) {
                    medList.push(value);
                    addMedTag(value);
                    updateMedHidden();
                }

                medInput.value = "";
            }
        });

        function addMedTag(text) {
            const tag = document.createElement("div");
            tag.className = "tag";
            tag.innerHTML = `${text} <span>&times;</span>`;

            tag.querySelector("span").onclick = function() {
                removeMed(text, tag);
            };

            medWrapper.insertBefore(tag, medInput);
        }

        function removeMed(text, tagElement) {
            medList = medList.filter(m => m !== text);
            tagElement.remove();
            updateMedHidden();
        }

        function updateMedHidden() {
            medHidden.value = medList.join(", ");
        }

        // age calculation part
        const dobInput = document.querySelector("input[name='dob']");
        const ageInput = document.getElementById("age");
        const ageContainer = document.getElementById("ageContainer");

        if (dobInput) {
        dobInput.addEventListener("change", () => {
            const dob = new Date(dobInput.value);
            const today = new Date();

            if (!isNaN(dob)) {
            let age = today.getFullYear() - dob.getFullYear();
            const m = today.getMonth() - dob.getMonth();
            if (m < 0 || (m === 0 && today.getDate() < dob.getDate())) {
                age--;
            }

            ageInput.value = age;
            ageContainer.style.display = "block";
            }
        });
        }


      alert(data.message);


      document.addEventListener("DOMContentLoaded", () => {
            const idType = document.getElementById("idType");
            const container = document.getElementById("idInputContainer");
            const input = document.getElementById("idNumber");

            idType.addEventListener("change", () => {
                const value = idType.value;

                if (!value) {
                container.style.display = "none";
                input.required = false;
                input.value = "";
                return;
                }

                container.style.display = "block";
                input.required = true;

                switch (value) {
                case "Aadhaar":
                    input.placeholder = "Enter Aadhaar Number (12 digits)";
                    input.maxLength = 12;
                    input.pattern = "[0-9]{12}";
                    break;

                case "Passport":
                    input.placeholder = "Enter Passport Number";
                    input.maxLength = 8;
                    input.pattern = "[A-Za-z0-9]{6,8}";
                    break;

                case "Voter ID":
                    input.placeholder = "Enter Voter ID";
                    input.maxLength = 10;
                    input.pattern = "[A-Z]{3}[0-9]{7}";
                    break;

                case "Driving License":
                    input.placeholder = "Enter Driving License Number";
                    input.maxLength = 16;
                    input.pattern = "[A-Za-z0-9]{6,16}";
                    break;

                case "PAN":
                    input.placeholder = "Enter PAN Number";
                    input.maxLength = 10;
                    input.pattern = "[A-Z]{5}[0-9]{4}[A-Z]";
                    break;
                }
            });
        });

        const backendAlert = "<%= typeof js_alert !== 'undefined' ? js_alert : '' %>";
        if (backendAlert) {
            alert(backendAlert);
        }

    </script>
</body>

</html>